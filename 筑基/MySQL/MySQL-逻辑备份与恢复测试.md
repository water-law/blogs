---
title: MySQL 逻辑备份与恢复测试
date: 2019-04-11 20:21:02
categories:
  - 数据库
tags:
  - MySQL
---

### 数据库备份使用场景

<!--more-->

一、数据丢失应用场景

1. 人为操作失误造成某些数据被误操作；
2. 软件 BUG 造成数据部分或者全部丢失；
3. 硬件故障造成数据库数据部分或全部丢失
4. 安全漏洞被入侵数据被恶意破坏；

二、非数据丢失应用场景

1. 特殊应用场景下基于时间点的数据恢复；
2. 开发测试环境数据库搭建；
3. 相同数据库的新环境搭建；
4. 数据库或者数据迁移；



### 逻辑备份与恢复测试

数据库逻辑备份就是备份软件按照我们最初所设计的逻辑关系，以数据库的逻辑结构对象为单位，将数据库中的数据按照预定义的逻辑关联格式一条一条生成相关的文本文件，以达到备份的目的。



#### 常用的逻辑备份

1. 生成 INSERT 语句备份

    mysqldump

   ```bash
   Dumping definition and data mysql database or table
   Usage: mysqldump [OPTIONS] database [tables]
   OR mysqldump [OPTIONS] --databases [OPTIONS] DB1 [DB2 DB3...]
   OR mysqldump [OPTIONS] --all-databases [OPTIONS]
   ```

   

2. 生成特定格式的纯文本备份数据文件备份

   - 通过执行 SELECT ... TO OUTFILE FROM ...命令来实现
   - 通过 mysqldump 导出

   

#### 逻辑备份恢复方法

1. INSERT 语句文件的恢复

   ```bash
   mysql < backup.sql
   ```

   

2. 纯数据文本备份的恢复

   一是通过 MySQL 的“LOAD DATA INFILE”命令来实现，另一种方法就是通过 MySQL
   提供的使用工具 mysqlimport 来进行恢复

优缺点：

1. 通过逻辑备份，我们可以通过执行相关 SQL 或者命令将数据库中的相关数据完全恢复到备份时候所处的状态，而不影响不相关的数据；
2. 通过全库的逻辑备份，我们可以在新的 MySQL 环境下完全重建出一个于备份时候完全一样的数据库，并且不受 MySQL 所处的平台类型限制；
3. 通过特定条件的逻辑备份，我们可以将某些特定数据轻松迁移（或者同步）到其他的 MySQL 或者另外的数据库环境；
4. 通过逻辑备份，我们可以仅仅恢复备份集中的部分数据而不需要全部恢复

#### 逻辑备份恢复测试

我们总不能真的将线上环境的数据进行恢复啊？是的，线上环境的数据确实不能被恢复，但是我们为什么不能在测试环境或者其他的地方做呢？做恢复测试只是为了验证我们的备份是否有效，是否能达到我们的预期。

###  物理备份与恢复测试

数据库的物理备份就是对数据库的物理对象所做的备份。

数据库的物理对象主要由数据库的物理数据文件、日志文件以及配置文件等组成。

#### MySQL 物理备份所需文件

1. MyISAM 存储引擎

   MyISAM 存储引擎的所有数据都存放在 MySQL 配置中所设定的 “datadir ” 目录下， 无日志。

2. Innodb 存储引擎

   决定 Innodb 存放数据位置的 配 置 为 “ innodb_data_home_dir ” 、 “ innodb_data_file_path” 和 “innodb_log_group_home_dir” 这三个目录位置指定参数，以及另外一个决定 Innodb 的表空间存储方式的参数 “innodb_file_per_table ” 。前面三个参数指定了数据和日志文件的存放位置，最后一个参数决定 Innodb 是以共享表空间存放数据还是以独享表空间方式存储数据。

   共享表空间的存储方式 ， 需要备份备份 “innodb_data_home_dir” 和 “innodb_data_file_path” 参数所设定的所有数据文件，“datadir” 中相应数据库目录下的所有 Innodb 存储引擎表的 “.frm” 文件；

   独享表空间，那么我们除了备份上面共享表空间方式所需要备份的所有文件之外，我们还需要备份“datadir”中相应数据库目录下的所有“.idb”文件，该文件中存放的才是独享表空间方式下 Innodb 存储引擎表的数据。
   此外，除了上面所说的数据文件之外，Innodb 还有自己存放 redo 信息和相关事务信息的日志文件在 “innodb_log_group_home_dir ” 参数所设定的位置。所以要想 Innodb 物理备份能够有效使用，我们还比需要备份 “innodb_log_group_home_dir” 参数所设定的位置的所有日志文件。

#### 针对存储引擎的备份方案

MySQL 自己提供了一个使用程序 mysqlhotcopy，这个程序就是专门用来备份 MyISAM 存储引擎的。

Innodb 存储引擎的开发者（ Innobase 公司）开发了一款名为 ibbackup 的商业备份软 件 ，专门实现 Innodb 存储引擎数据的在线物理备份功能。

[MySQL主从复制技术（纯干货）](https://www.cnblogs.com/jiangwenju/p/6098974.html)

#### 个人经验

1.  对于较为核心的在线应用系统，需要有在线备用主机通过 MySQL 的复制进行相应的备份，复制线程可以一直开启，恢复线程可以每天恢复一次，尽量让备机的数据延后主机在一定的时间段之内。这个延后的时间多长合适主要是根据实际需求决定，一般来说延后一天是一个比较常规的做法。
2. 对于重要级别稍微低一些的应用，恢复时间要求不是太高的话，为了节约硬件成 本 ，不必要使用在线的备份主机来单独运行备用 MySQL，而是通过每一定的时间周期内进行一次物理全备份，同时每小时（或者其他合适的时间段）内将产生的二进制日志进行备份。这样虽然没有第一种备份方法恢复快，但是数据的丢失会比较少。恢复所需要的时间由全备周期长短所决定。
3. 而对于恢复基本没有太多时间要求，但是不希望太多数据丢失的应用场景，则可以通过每一定时间周期内进行一次逻辑全备份，同时也备份相应的二进制日志。使用逻辑备份而不使用物理备份的原因是因为逻辑备份实现简单，可以完全在线联机完成，备份过程不会影响应用提供服务。
4. 对于一些搭建临时数据库的备份应用场景，则仅仅只需要通过一个逻辑全备份即可满足需求，都不需要用二进制日志来进行恢复，因为这样的需求对数据并没有太苛刻的要求。