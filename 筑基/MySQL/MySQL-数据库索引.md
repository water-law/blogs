---
title: MySQL 数据库索引
date: 2019-03-19 21:27:45
categories:
  - 数据库
tags:
  - MySQL
---

本文使用的是 8.0.15 MySQL Community Server 版本， 该版本基于 GPL 协议分发源码。

<!--more-->

## 存储引擎

MySQL 中最常用的两种存储引擎是 MyISAM 和 InnoDB

MyISAM



InnoDB

## 索引

1. 经常被查询的字段
2. 不需要全表扫描



## 索引类型

查看数据库中表使用的引擎

```mysql
mysql> show create table user;
+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table | Create Table                                                                                                                                                                                                                                                                               |
+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| user  | CREATE TABLE `user` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(20) NOT NULL,
  `desc` text NOT NULL,
  `age` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `index_name` (`name`)
) ENGINE=InnoDB AUTO_INCREMENT=1000001 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci |
+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.03 sec)
```

可以看到， 此版本的 MySQL 创建表示默认使用 InnoDB 存储引擎 和 utf8mb4 字符集。

### 普通索引

```mysql
mysql> alter table user add index index_name(`name`)

```

索引没有起作用

```mysql

mysql> explain select * from user where name='1';
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+-------+
| id | select_type | table | partitions | type | possible_keys | key        | key_len | ref   | rows  | filtered | Extra |
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+-------+
|  1 | SIMPLE      | user  | NULL       | ref  | index_name    | index_name | 82      | const | 78650 |   100.00 | NULL  |
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+-------+
1 row in set, 1 warning (0.00 sec)
```

```mysql

mysql> explain select name, age from user where name='1';
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+-------+
| id | select_type | table | partitions | type | possible_keys | key        | key_len | ref   | rows  | filtered | Extra |
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+-------+
|  1 | SIMPLE      | user  | NULL       | ref  | index_name    | index_name | 82      | const | 78650 |   100.00 | NULL  |
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+-------+
1 row in set, 1 warning (0.01 sec)
```

索引起作用

```mysql

mysql> explain select name from user where name='1';
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+-------------+
| id | select_type | table | partitions | type | possible_keys | key        | key_len | ref   | rows  | filtered | Extra       |
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+-------------+
|  1 | SIMPLE      | user  | NULL       | ref  | index_name    | index_name | 82      | const | 78650 |   100.00 | Using index |
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+-------------+
1 row in set, 1 warning (0.00 sec)
```

这种索引包含满足查询的所有数据，就称为**覆盖索引**。覆盖索引是一种非常强大的工具，能大大提高查询性能。

在大多数引擎中，只有当查询语句所访问的列是索引的一部分时，索引才会覆盖。但是，InnoDB 不限于此，InnoDB 的二级索引在叶子节点中存储了primary key 的值。因此，user 表使用 InnoDB，而且对于是 name 上有索引，所以，索引能覆盖那些访问 id 的查询，如：

```mysql
mysql> explain select id, name from user where name='1';
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+-------------+
| id | select_type | table | partitions | type | possible_keys | key        | key_len | ref   | rows  | filtered | Extra       |
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+-------------+
|  1 | SIMPLE      | user  | NULL       | ref  | index_name    | index_name | 82      | const | 78650 |   100.00 | Using index |
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+-------------+
1 row in set, 1 warning (0.00 sec)
```

### 使用索引排序

MySQL 中，有两种方式生成有序结果集：一是使用 filesort，二是按索引顺序扫描。利用索引进行排序操作是非常快的，而且可以利用同一索引同时进行查找和排序操作。当索引的顺序与 ORDER BY 中的列顺序相同且所有的列是同一方向(全部升序或者全部降序)时，可以使用索引来排序。如果查询是连接多个表，仅当 ORDER BY 中的所有列都是第一个表的列时才会使用索引。其它情况都会使用 filesort。

```mysql
mysql> explain select id, name from user where name='1' order by id;
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+-------------+
| id | select_type | table | partitions | type | possible_keys | key        | key_len | ref   | rows  | filtered | Extra       |
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+-------------+
|  1 | SIMPLE      | user  | NULL       | ref  | index_name    | index_name | 82      | const | 78650 |   100.00 | Using index |
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+-------------+
1 row in set, 1 warning (0.02 sec)
```

```mysql

mysql> explain select id, name from user where name='1' order by name;
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+-------------+
| id | select_type | table | partitions | type | possible_keys | key        | key_len | ref   | rows  | filtered | Extra       |
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+-------------+
|  1 | SIMPLE      | user  | NULL       | ref  | index_name    | index_name | 82      | const | 78650 |   100.00 | Using index |
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+-------------+
1 row in set, 1 warning (0.00 sec)
```

使用 filesort 的场景

```mysql
mysql> explain select id, name from user where name='1' order by age;
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+----------------+
| id | select_type | table | partitions | type | possible_keys | key        | key_len | ref   | rows  | filtered | Extra          |
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+----------------+
|  1 | SIMPLE      | user  | NULL       | ref  | index_name    | index_name | 82      | const | 78650 |   100.00 | Using filesort |
+----+-------------+-------+------------+------+---------------+------------+---------+-------+-------+----------+----------------+
1 row in set, 1 warning (0.03 sec)
```

### 事务

MYSQL 事务处理主要有两种方法：

1、用 BEGIN, ROLLBACK, COMMIT来实现

- **BEGIN** 开始一个事务
- **ROLLBACK** 事务回滚
- **COMMIT** 事务确认

2、直接用 SET 来改变 MySQL 的自动提交模式:

- **SET AUTOCOMMIT=0** 禁止自动提交
- **SET AUTOCOMMIT=1** 开启自动提交

控制事务提交还是回滚

```mysql
SET AUTOCOMMIT=0；
BEGIN;
xxx;
ROLLBACK;
COMMIT;
```

